<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Queue</title>

    <link rel="stylesheet" menuItem="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/css/patternfly.min.css">
    <link rel="stylesheet" menuItem="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/css/patternfly-additions.min.css">
</head>
<body onload="connect()">
<div class="container" id="order-result-message"></div>

<div class="container">

    <h1>Queue</h1>

    <table class="table table-striped">
        <thead class="thead-dark">
        <tr>
            <th>Customer</th>
            <th>Product</th>
            <th>Prepared By</th>
            <th>State</th>
        </tr>
        </thead>
        <tbody>

        </tbody>
    </table>

</div>

</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/js/patternfly.min.js"></script>
<script language="JavaScript">
    var connected = false;

    var connect = function() {
        if (! connected) {
            var id = uuid();
            console.log("Val: " + id);
            socket = new WebSocket("ws://" + location.host + "/dashboard/updates/" + id);
            socket.onopen = function() {
                connected = true;
                console.log("Connected to the web socket");
            };
            socket.onmessage = function(event) {
                console.log("Got message: " + event);
                updateTable(event);
//                $("#chat").append(m.data + "\n");
//                scrollToBottom();
            };
        }
    };

    var uuid = function(){
        var dt = new Date().getTime();
        var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = (dt + Math.random()*16)%16 | 0;
            dt = Math.floor(dt/16);
            return (c=='x' ? r :(r&0x3|0x8)).toString(16);
        });
        return uuid;
    }

    var updateTable = function(msg){

        console.log("Got message: " + msg.data);

        var state = JSON.parse(msg.data);
        if(state.status=="IN_QUEUE")
            $("tbody").append(line(state));
        if(state.status=="READY")
            $("#"+state.itemId).replaceWith(line(state));
    };

    var line = function(state) {
        var orderId = state.orderId;
        var id = state.itemId;
        var product = state.item;
        var customer = state.name;
        var status = state.status;
        var barista = "";
        return "<tr id='" + id + "'>" +
            "<td>" + customer + "</td>" +
            "<td>" + product + "</td>" +
            "<td>" + barista + "</td>" +
            "<td>" + status + "</td></tr>";
    }


</script>
</html>
